<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="WindStation">
<meta name="theme-color" content="#080c10">
<title>WindStation</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@300;400;600;700&family=Share+Tech+Mono&display=swap');
:root{
  --bg:#080c10;--bg2:#0d1117;--bg3:#131920;
  --border:#1e2d3d;--accent:#00d4ff;
  --green:#00ff88;--yellow:#ffd700;--red:#ff4444;
  --text:#c8d8e8;--dim:#4a6070;
}
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent}
body{background:var(--bg);color:var(--text);font-family:'Rajdhani',sans-serif;min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;
  background-image:linear-gradient(rgba(0,212,255,0.03) 1px,transparent 1px),
                   linear-gradient(90deg,rgba(0,212,255,0.03) 1px,transparent 1px);
  background-size:40px 40px;pointer-events:none;z-index:0}
.wrap{position:relative;z-index:1}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 18px;
  border-bottom:1px solid var(--border);background:rgba(13,17,23,0.95);
  backdrop-filter:blur(10px);position:sticky;top:0;z-index:100}
.logo{font-size:1.4em;font-weight:700;letter-spacing:3px;color:var(--accent);text-transform:uppercase}
.logo span{color:var(--dim);font-weight:300}
.header-right{display:flex;align-items:center;gap:10px}
.unit-toggle{display:flex;background:var(--bg3);border:1px solid var(--border);border-radius:8px;overflow:hidden}
.unit-toggle button{padding:6px 14px;border:none;background:transparent;color:var(--dim);
  font-family:'Rajdhani',sans-serif;font-size:.95em;font-weight:600;cursor:pointer;letter-spacing:1px;transition:all .2s}
.unit-toggle button.active{background:var(--accent);color:#000}

/* BLE STATUS */
.ble-btn{display:flex;align-items:center;gap:6px;padding:6px 14px;
  border:1px solid var(--border);border-radius:8px;background:var(--bg3);
  color:var(--dim);font-family:'Rajdhani',sans-serif;font-size:.9em;font-weight:600;
  cursor:pointer;letter-spacing:1px;transition:all .3s;white-space:nowrap}
.ble-btn.connected{border-color:var(--green);color:var(--green)}
.ble-btn.connecting{border-color:var(--yellow);color:var(--yellow)}
.ble-dot{width:7px;height:7px;border-radius:50%;background:currentColor;flex-shrink:0}
.ble-btn.connected .ble-dot{animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(0,255,136,.4)}50%{opacity:.7;box-shadow:0 0 0 5px rgba(0,255,136,0)}}

/* CONNECT OVERLAY */
.overlay{position:fixed;inset:0;background:rgba(8,12,16,.97);z-index:200;
  display:flex;flex-direction:column;align-items:center;justify-content:center;gap:24px;
  transition:opacity .4s}
.overlay.hidden{opacity:0;pointer-events:none}
.overlay-logo{font-size:2.2em;font-weight:700;letter-spacing:4px;color:var(--accent)}
.overlay-logo span{color:var(--dim);font-weight:300}
.overlay-sub{font-size:.9em;color:var(--dim);letter-spacing:2px;text-transform:uppercase}
.connect-btn{padding:16px 40px;border:1px solid var(--accent);border-radius:14px;
  background:transparent;color:var(--accent);font-family:'Rajdhani',sans-serif;
  font-size:1.2em;font-weight:700;letter-spacing:3px;cursor:pointer;text-transform:uppercase;
  transition:all .2s;position:relative;overflow:hidden}
.connect-btn::before{content:'';position:absolute;inset:0;
  background:var(--accent);opacity:0;transition:opacity .2s}
.connect-btn:active::before{opacity:.15}
.connect-btn:hover{box-shadow:0 0 30px rgba(0,212,255,.3)}
.overlay-note{font-size:.75em;color:var(--dim);text-align:center;max-width:300px;line-height:1.6}
.overlay-err{font-size:.8em;color:var(--red);text-align:center;min-height:1.2em}

/* NAV */
.nav{display:flex;border-bottom:1px solid var(--border);background:var(--bg2)}
.nav button{flex:1;padding:11px 5px;border:none;background:transparent;color:var(--dim);
  font-family:'Rajdhani',sans-serif;font-size:1em;font-weight:600;letter-spacing:2px;cursor:pointer;
  text-transform:uppercase;border-bottom:2px solid transparent;transition:all .2s}
.nav button.active{color:var(--accent);border-bottom-color:var(--accent)}

.tab{display:none;padding:16px}

/* GAUGE */
.gauge-wrap{position:relative;width:280px;margin:0 auto 4px}
#gaugeCanvas{display:block;margin:0 auto}
.gauge-center{position:absolute;bottom:14px;left:50%;transform:translateX(-50%);text-align:center;pointer-events:none}
.gauge-val{font-family:'Share Tech Mono',monospace;font-size:2.6em;color:#fff;line-height:1;text-shadow:0 0 20px var(--accent)}
.gauge-unit{font-size:.85em;color:var(--dim);letter-spacing:2px;margin-top:2px}
.beaufort{text-align:center;margin:6px 0 10px}
.bf-badge{display:inline-block;padding:4px 16px;border-radius:20px;font-size:.8em;
  font-weight:600;letter-spacing:2px;text-transform:uppercase;border:1px solid currentColor;transition:all .3s}

/* STATS */
.stats{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:10px 0}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:14px;text-align:center;position:relative;overflow:hidden}
.stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,var(--accent),transparent);opacity:.4}
.stat-label{font-size:.7em;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin-bottom:6px}
.stat-val{font-family:'Share Tech Mono',monospace;font-size:1.4em;color:var(--text)}

/* CHART */
.chart-wrap{position:relative;background:var(--bg2);border:1px solid var(--border);border-radius:12px;overflow:hidden;margin-top:10px}
.chart-header{display:flex;justify-content:space-between;align-items:center;padding:8px 12px 0}
.chart-label{font-size:.7em;letter-spacing:3px;color:var(--dim);text-transform:uppercase}
.chart-hint{font-size:.65em;color:var(--dim);letter-spacing:1px}
canvas.chart{display:block;width:100%;cursor:crosshair;touch-action:none}
.live-dot{display:inline-block;width:7px;height:7px;background:var(--green);border-radius:50%;
  margin-right:6px;animation:pulse 1.5s infinite}

/* HISTORY */
.hist-controls{display:flex;align-items:center;gap:8px;flex-wrap:wrap;
  margin-bottom:12px;background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:12px}
select{flex:1;min-width:0;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);
  border-radius:8px;color:var(--text);font-family:'Rajdhani',sans-serif;font-size:.95em}
.btn{padding:8px 14px;border:1px solid var(--accent);border-radius:8px;background:transparent;
  color:var(--accent);font-family:'Rajdhani',sans-serif;font-size:.9em;font-weight:600;
  letter-spacing:1px;cursor:pointer;white-space:nowrap;transition:all .2s}
.btn:active{background:var(--accent);color:#000}
.btn-del{border-color:var(--red);color:var(--red)}
.btn-del:active{background:var(--red);color:#000}
.progress-bar{height:3px;background:var(--border);border-radius:2px;margin:8px 0;overflow:hidden;display:none}
.progress-bar-fill{height:100%;background:var(--accent);width:0%;transition:width .1s;border-radius:2px}

/* SETUP */
.setting-card{background:var(--bg2);border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px}
.setting-title{font-size:.7em;letter-spacing:3px;color:var(--dim);text-transform:uppercase;margin-bottom:12px}
.setting-row{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.setting-row label{font-size:.85em;color:var(--dim);white-space:nowrap;min-width:80px}
input[type="number"],input[type="datetime-local"],input[type="text"]{
  flex:1;padding:8px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:8px;
  color:var(--text);font-family:'Share Tech Mono',monospace;font-size:.9em}
input:focus{outline:1px solid var(--accent)}
.zone-row{display:grid;grid-template-columns:1fr 1fr 1fr;gap:6px;margin-bottom:6px}
.zone-row input{min-width:0}
.btn-restart{border-color:#ff8800;color:#ff8800}
.btn-restart:active{background:#ff8800;color:#000}
</style>
</head>
<body>
<div class="wrap">

<!-- CONNECT OVERLAY -->
<div class="overlay" id="overlay">
  <div class="overlay-logo">Wind<span>Station</span></div>
  <div class="overlay-sub">Bluetooth Verbindung</div>
  <button class="connect-btn" onclick="bleConnect()">&#9889; Verbinden</button>
  <div class="overlay-note">
    Stelle sicher, dass Bluetooth aktiviert ist und du dich in der Naehe der WindStation befindest.
  </div>
  <div class="overlay-err" id="bleErr"></div>
</div>

<div class="header">
  <div class="logo">Wind<span>Station</span></div>
  <div class="header-right">
    <div class="unit-toggle">
      <button id="btnMS" class="active" onclick="setUnit('ms')">m/s</button>
      <button id="btnKMH" onclick="setUnit('kmh')">km/h</button>
    </div>
    <button class="ble-btn" id="bleBtn" onclick="bleDisconnect()">
      <div class="ble-dot"></div>
      <span id="bleBtnLabel">Getrennt</span>
    </button>
  </div>
</div>

<div class="nav">
  <button class="active" onclick="showTab('live',this)">Live</button>
  <button onclick="showTab('history',this)">Historie</button>
  <button onclick="showTab('cal',this)">Setup</button>
</div>

<!-- LIVE -->
<div id="live" class="tab" style="display:block">
  <div class="gauge-wrap">
    <canvas id="gaugeCanvas" width="280" height="168"></canvas>
    <div class="gauge-center">
      <div class="gauge-val" id="gaugeVal">0.0</div>
      <div class="gauge-unit" id="gaugeUnit">m/s</div>
    </div>
  </div>
  <div class="beaufort"><span class="bf-badge" id="bfBadge">Windstille</span></div>
  <div class="stats">
    <div class="stat-card">
      <div class="stat-label">Mittelwert</div>
      <div class="stat-val" id="avgVal">--</div>
    </div>
    <div class="stat-card">
      <div class="stat-label">Maximum</div>
      <div class="stat-val" id="maxVal">--</div>
    </div>
  </div>
  <div class="chart-wrap">
    <div class="chart-header">
      <div class="chart-label"><span class="live-dot"></span>Verlauf (letzte 60s)</div>
      <div class="chart-hint" id="liveChartTime"></div>
    </div>
    <canvas id="lineCanvas" class="chart" height="160"></canvas>
  </div>
</div>

<!-- HISTORY -->
<div id="history" class="tab">
  <div class="hist-controls">
    <select id="fileSelect"><option>-- Verbinden --</option></select>
    <button class="btn" onclick="loadHistory()">Laden</button>
    <button class="btn btn-del" onclick="deleteFile()">&#128465;</button>
  </div>
  <div class="progress-bar" id="progBar"><div class="progress-bar-fill" id="progFill"></div></div>
  <div class="chart-wrap">
    <div class="chart-header">
      <div class="chart-label" id="histLabel">Verlauf</div>
      <div class="chart-hint">Scroll / Pinch = Zoom</div>
    </div>
    <canvas id="histCanvas" class="chart" height="240"></canvas>
  </div>
</div>

<!-- SETUP -->
<div id="cal" class="tab">
  <div class="setting-card">
    <div class="setting-title">Kalibrierung &amp; Uhrzeit</div>
    <div class="setting-row">
      <label>Faktor</label>
      <input type="number" step="0.01" id="calFactor" placeholder="m/s pro Volt (3.33)">
      <button class="btn" onclick="setCal()">OK</button>
    </div>
    <div class="setting-row">
      <label>Uhrzeit</label>
      <input type="datetime-local" id="datetime">
      <button class="btn" onclick="setTime()">OK</button>
    </div>
    <button class="btn" style="width:100%;margin-top:4px" onclick="setTimeNow()">Uhrzeit = Jetzt</button>
  </div>
  <div class="setting-card">
    <div class="setting-title">Tacho-Anzeige</div>
    <div class="setting-row">
      <label>Max-Wert</label>
      <input type="number" id="cfgMax" value="30" min="5" max="200" step="1">
      <span style="font-size:.8em;color:var(--dim);white-space:nowrap">m/s</span>
    </div>
    <div class="setting-row">
      <label>Nachkomma</label>
      <input type="number" id="cfgDec" value="1" min="0" max="3" step="1">
    </div>
    <button class="btn" style="width:100%;margin-top:4px" onclick="applyGaugeCfg()">Uebernehmen</button>
  </div>
  <div class="setting-card">
    <div class="setting-title">Farbzonen (% vom Max)</div>
    <div style="display:grid;grid-template-columns:60px 1fr 1fr;gap:6px;margin-bottom:6px;font-size:.75em;color:var(--dim)">
      <span>Zone</span><span>bis %</span><span>Farbe</span>
    </div>
    <div class="zone-row">
      <span style="font-size:.8em;color:var(--green);padding:8px 0">Gruen</span>
      <input type="number" id="z1end" value="33" min="1" max="99">
      <input type="text" id="z1col" value="#00e676" maxlength="7">
    </div>
    <div class="zone-row">
      <span style="font-size:.8em;color:var(--yellow);padding:8px 0">Gelb</span>
      <input type="number" id="z2end" value="66" min="1" max="99">
      <input type="text" id="z2col" value="#ffd700" maxlength="7">
    </div>
    <div class="zone-row">
      <span style="font-size:.8em;color:var(--red);padding:8px 0">Rot</span>
      <span style="font-size:.8em;color:var(--dim);padding:8px 0">100</span>
      <input type="text" id="z3col" value="#ff4444" maxlength="7">
    </div>
    <button class="btn" style="width:100%;margin-top:4px" onclick="applyZones()">Uebernehmen</button>
  </div>
  <div class="setting-card">
    <div class="setting-title">Kategorien (Grenze m/s &amp; Name &amp; Farbe)</div>
    <div id="bfEditor"></div>
    <button class="btn" style="width:100%;margin-top:8px" onclick="buildBfEditor()">Aktualisieren</button>
  </div>
  <div class="setting-card" style="border-color:#ff8800">
    <div class="setting-title" style="color:#ff8800">System</div>
    <button class="btn" style="width:100%;margin-bottom:8px" onclick="resetMax()">Maximum zuruecksetzen</button>
    <button class="btn btn-restart" style="width:100%" onclick="doRestart()">&#8635; ESP neu starten</button>
  </div>
</div>

</div><!-- .wrap -->

<script>
// ===================== BLE =====================
const SERVICE_UUID   = '12345678-1234-1234-1234-123456789abc';
const WIND_UUID      = '12345678-1234-1234-1234-123456789ab1';
const CMD_UUID       = '12345678-1234-1234-1234-123456789ab2';
const HIST_UUID      = '12345678-1234-1234-1234-123456789ab3';

let bleDevice = null, bleServer = null;
let windChar = null, cmdChar = null, histChar = null;

// History streaming state
let histLines = [];
let histStreaming = false;
let histExpectDone = false;
let fileListResolve = null;
let histTotalEstimate = 0; // für Fortschrittsbalken

async function bleConnect(){
  const errEl = document.getElementById('bleErr');
  errEl.textContent = '';
  setBleStatus('connecting');
  try {
    bleDevice = await navigator.bluetooth.requestDevice({
      filters: [{name: 'WindStation'}],
      optionalServices: [SERVICE_UUID]
    });
    bleDevice.addEventListener('gattserverdisconnected', onBleDisconnect);
    bleServer = await bleDevice.gatt.connect();
    const service = await bleServer.getPrimaryService(SERVICE_UUID);
    windChar = await service.getCharacteristic(WIND_UUID);
    cmdChar  = await service.getCharacteristic(CMD_UUID);
    histChar = await service.getCharacteristic(HIST_UUID);

    await windChar.startNotifications();
    windChar.addEventListener('characteristicvaluechanged', onWindData);

    await histChar.startNotifications();
    histChar.addEventListener('characteristicvaluechanged', onHistData);

    setBleStatus('connected');
    document.getElementById('overlay').classList.add('hidden');
    loadFileList();

  } catch(e){
    console.error(e);
    errEl.textContent = e.message || 'Verbindung fehlgeschlagen';
    setBleStatus('disconnected');
    bleDevice = null;
  }
}

function bleDisconnect(){
  if(bleDevice && bleDevice.gatt.connected){
    bleDevice.gatt.disconnect();
  }
}

function onBleDisconnect(){
  setBleStatus('disconnected');
  document.getElementById('overlay').classList.remove('hidden');
  bleDevice = null; bleServer = null; windChar = null; cmdChar = null; histChar = null;
}

function setBleStatus(s){
  const btn = document.getElementById('bleBtn');
  const lbl = document.getElementById('bleBtnLabel');
  btn.className = 'ble-btn';
  if(s === 'connected'){   btn.classList.add('connected');  lbl.textContent = 'Verbunden'; }
  if(s === 'connecting'){  btn.classList.add('connecting'); lbl.textContent = 'Verbinde...'; }
  if(s === 'disconnected'){ lbl.textContent = 'Getrennt'; }
}

async function sendCommand(cmd){
  if(!cmdChar){ alert('Nicht verbunden!'); return false; }
  try {
    const enc = new TextEncoder();
    await cmdChar.writeValueWithoutResponse(enc.encode(cmd));
    return true;
  } catch(e){ console.error('CMD Fehler:', e); return false; }
}

// ===================== WIND DATEN =====================
function onWindData(e){
  const dec = new TextDecoder();
  const txt = dec.decode(e.target.value);
  try {
    const j = JSON.parse(txt);
    const cur = parseFloat(j.c), avg = parseFloat(j.a), mx = parseFloat(j.m);
    const timeStr = j.t || '';
    drawGauge(cur);
    document.getElementById('avgVal').textContent = toDisplay(avg).toFixed(gCfg.dec) + ' ' + unitLabel();
    document.getElementById('maxVal').textContent = toDisplay(mx).toFixed(gCfg.dec) + ' ' + unitLabel();
    lineData.push(cur); lineTimestamps.push(timeStr);
    if(lineData.length > 600){ lineData.shift(); lineTimestamps.shift(); }
    drawLineChart();
  } catch(err){}
}

// ===================== HISTORY / FILE DATA =====================
function onHistData(e){
  const dec = new TextDecoder();
  const line = dec.decode(e.target.value).trim();

  // Dateiliste
  if(line.startsWith('FILES:')){
    const files = line.substring(6).split(',').filter(f => f.endsWith('.csv'));
    if(fileListResolve){ fileListResolve(files); fileListResolve = null; }
    return;
  }

  // History stream
  if(line === 'HIST:START'){
    // Nur zurücksetzen wenn wir nicht schon streamen
    // (verhindert Neustart durch doppelte Notification)
    if(!histStreaming){
      histLines = [];
      histStreaming = true;
      histTotalEstimate = 0;
      document.getElementById('progBar').style.display = 'block';
      document.getElementById('progFill').style.width = '2%';
      document.getElementById('histLabel').textContent = 'Lade...';
    }
    return;
  }
  if(line === 'HIST:DONE'){
    histStreaming = false;
    document.getElementById('progBar').style.display = 'none';
    renderHistoryChart();
    return;
  }
  if(histStreaming && line.length > 0 && !line.startsWith('Zeit')){
    histLines.push(line);
    const cnt = histLines.length;
    // Fortschrittsbalken: wächst kontinuierlich, nie zurück
    // Schätzen: typische Tagesdatei ~86400 Zeilen max
    // Wir zeigen einfach den Zähler und einen nie-zurückgehenden Balken
    // der sich asymptotisch 100% nähert
    const barPct = Math.min(98, 100 * (1 - 1 / (1 + cnt / 500)));
    document.getElementById('progFill').style.width = barPct.toFixed(1) + '%';
    document.getElementById('histLabel').textContent = 'Lade... ' + cnt + ' Zeilen';
  }
}

// ===================== FILE FUNCTIONS =====================
async function loadFileList(){
  if(!cmdChar) return;
  const files = await new Promise(resolve => {
    fileListResolve = resolve;
    sendCommand('listfiles');
    // Timeout falls keine Antwort
    setTimeout(() => { if(fileListResolve){ fileListResolve([]); fileListResolve=null; } }, 5000);
  });
  const sel = document.getElementById('fileSelect');
  sel.innerHTML = '';
  if(!files.length){
    sel.innerHTML = '<option>Keine Dateien</option>'; return;
  }
  files.forEach(f => {
    const o = document.createElement('option');
    o.value = o.textContent = f; sel.appendChild(o);
  });
}

async function loadHistory(){
  const sel = document.getElementById('fileSelect');
  if(!sel.value || !cmdChar) return;
  histLines = [];
  document.getElementById('histLabel').textContent = 'Lade...';
  await sendCommand('history:' + sel.value);
}

function renderHistoryChart(){
  histData = []; histTimestamps = [];
  histLines.forEach(l => {
    const p = l.split(',');
    if(p[1]){ histData.push(parseFloat(p[1])); histTimestamps.push(p[0]); }
  });
  histZoom = {start:0, end:1};
  initHC(); drawHistChart();
  document.getElementById('histLabel').textContent =
    'Verlauf (' + histData.length + ' Messpunkte)';
}

async function deleteFile(){
  const sel = document.getElementById('fileSelect');
  if(!sel.value) return;
  if(!confirm('Datei loeschen: ' + sel.value + '?')) return;
  await sendCommand('delete:' + sel.value);
  histData = []; histTimestamps = []; drawHistChart();
  setTimeout(loadFileList, 500);
}

// ===================== SETUP FUNKTIONEN =====================
function setCal(){
  const v = document.getElementById('calFactor').value;
  if(v) sendCommand('cal:' + v).then(ok => { if(ok) alert('Gespeichert'); });
}
function setTime(){
  const d = document.getElementById('datetime').value;
  if(d) sendCommand('time:' + d).then(ok => { if(ok) alert('Uhrzeit gesetzt'); });
}
function setTimeNow(){
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const dt = now.getFullYear()+'-'+pad(now.getMonth()+1)+'-'+pad(now.getDate())+
             'T'+pad(now.getHours())+':'+pad(now.getMinutes());
  document.getElementById('datetime').value = dt;
  sendCommand('time:' + dt).then(ok => { if(ok) alert('Uhrzeit auf Jetzt gesetzt'); });
}
function doRestart(){
  if(confirm('ESP neu starten?')) sendCommand('restart');
}
function resetMax(){
  sendCommand('resetmax');
}

// ===================== UNIT =====================
let unit = 'ms';
function setUnit(u){
  unit = u;
  document.getElementById('btnMS').classList.toggle('active', u==='ms');
  document.getElementById('btnKMH').classList.toggle('active', u==='kmh');
  document.getElementById('gaugeUnit').textContent = u==='ms' ? 'm/s' : 'km/h';
  drawLineChart(); drawHistChart();
}
function toDisplay(ms){ return unit==='ms' ? ms : ms*3.6; }
function unitLabel(){ return unit==='ms' ? 'm/s' : 'km/h'; }

// ===================== GAUGE CONFIG =====================
let gCfg = {maxMS:30, dec:1};
let zones = [
  {end:.33, color:'#00e676'},
  {end:.66, color:'#ffd700'},
  {end:1.0, color:'#ff4444'},
];
function applyGaugeCfg(){
  gCfg.maxMS = parseFloat(document.getElementById('cfgMax').value)||30;
  gCfg.dec   = parseInt(document.getElementById('cfgDec').value)||1;
}
function applyZones(){
  zones = [
    {end:parseFloat(document.getElementById('z1end').value)/100, color:document.getElementById('z1col').value},
    {end:parseFloat(document.getElementById('z2end').value)/100, color:document.getElementById('z2col').value},
    {end:1, color:document.getElementById('z3col').value},
  ];
}
function maxScale(){ return unit==='ms' ? gCfg.maxMS : gCfg.maxMS*3.6; }

// ===================== BEAUFORT =====================
let bfLevels = [
  {limit:0.3,  text:'Windstille',     color:'#4a8fff'},
  {limit:1.6,  text:'Leiser Zug',     color:'#4adfff'},
  {limit:3.4,  text:'Leichte Brise',  color:'#00e676'},
  {limit:5.5,  text:'Schwache Brise', color:'#00e676'},
  {limit:8.0,  text:'Maessige Brise', color:'#b0e020'},
  {limit:10.8, text:'Frische Brise',  color:'#ffd700'},
  {limit:13.9, text:'Starker Wind',   color:'#ffa500'},
  {limit:17.2, text:'Steifer Wind',   color:'#ff6600'},
  {limit:20.8, text:'Stuermisch',     color:'#ff3300'},
  {limit:24.5, text:'Sturm',          color:'#ff0000'},
  {limit:999,  text:'Orkan',          color:'#cc0000'},
];
function buildBfEditor(){
  const el = document.getElementById('bfEditor'); el.innerHTML='';
  bfLevels.forEach((b,i)=>{
    const row=document.createElement('div');
    row.style.cssText='display:flex;gap:6px;align-items:center;margin-bottom:6px';
    const lim=document.createElement('input'); lim.type='number'; lim.step='.1';
    lim.value=b.limit===999?'':b.limit; lim.placeholder='bis'; lim.style.width='62px';
    const txt=document.createElement('input'); txt.type='text'; txt.value=b.text; txt.style.flex='1';
    const col=document.createElement('input'); col.type='text'; col.value=b.color; col.maxLength=7; col.style.width='76px';
    lim.oninput=e=>{if(e.target.value)bfLevels[i].limit=parseFloat(e.target.value);};
    txt.oninput=e=>{bfLevels[i].text=e.target.value;};
    col.oninput=e=>{bfLevels[i].color=e.target.value;};
    row.append(lim,txt,col); el.appendChild(row);
  });
}
function beaufort(ms){
  for(let b of bfLevels) if(ms<b.limit) return b;
  return bfLevels[bfLevels.length-1];
}

// ===================== TAB =====================
function showTab(id,btn){
  document.querySelectorAll('.tab').forEach(t=>t.style.display='none');
  document.getElementById(id).style.display='block';
  document.querySelectorAll('.nav button').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  if(id==='cal') buildBfEditor();
  if(id==='history' && (!document.getElementById('fileSelect').options.length ||
     document.getElementById('fileSelect').options[0].text==='-- Verbinden --')) loadFileList();
}

// ===================== GAUGE =====================
const GC = document.getElementById('gaugeCanvas');
const GCX = GC.getContext('2d');
function drawGauge(val_ms){
  const val=toDisplay(val_ms), max=maxScale();
  const W=GC.width,H=GC.height,cx=W/2,cy=H-10,r=120,lw=20;
  GCX.clearRect(0,0,W,H);
  GCX.beginPath(); GCX.arc(cx,cy,r,Math.PI,0,false);
  GCX.lineWidth=lw+8; GCX.strokeStyle='rgba(0,100,150,0.10)'; GCX.stroke();
  GCX.beginPath(); GCX.arc(cx,cy,r,Math.PI,0,false);
  GCX.lineWidth=lw; GCX.strokeStyle='#131920'; GCX.stroke();
  let prev=0;
  zones.forEach(z=>{
    GCX.beginPath(); GCX.arc(cx,cy,r,Math.PI+prev*Math.PI,Math.PI+z.end*Math.PI,false);
    GCX.lineWidth=lw; GCX.strokeStyle=z.color+'20'; GCX.stroke(); prev=z.end;
  });
  const frac=Math.min(val/max,1);
  if(frac>0){
    const endAngle=Math.PI+frac*Math.PI;
    const activeColor=zones.find(z=>frac<=z.end)?.color||zones[zones.length-1].color;
    GCX.shadowColor=activeColor; GCX.shadowBlur=22;
    const grad=GCX.createLinearGradient(cx-r,cy,cx+r,cy);
    grad.addColorStop(0,zones[0].color);
    zones.forEach(z=>grad.addColorStop(Math.min(z.end,1),z.color));
    GCX.beginPath(); GCX.arc(cx,cy,r,Math.PI,endAngle,false);
    GCX.lineWidth=lw; GCX.lineCap='round'; GCX.strokeStyle=grad; GCX.stroke();
    GCX.shadowBlur=0;
  }
  GCX.lineCap='butt';
  for(let i=0;i<=10;i++){
    const angle=Math.PI+(i/10)*Math.PI, big=i%2===0;
    GCX.beginPath();
    GCX.moveTo(cx+Math.cos(angle)*(r-lw-4),cy+Math.sin(angle)*(r-lw-4));
    GCX.lineTo(cx+Math.cos(angle)*(r-(big?32:22)),cy+Math.sin(angle)*(r-(big?32:22)));
    GCX.lineWidth=big?2:1; GCX.strokeStyle=big?'#3a5060':'#1e2d3d'; GCX.stroke();
    if(big){
      const tr=r-44,lval=(i/10)*max;
      GCX.fillStyle='#2a4050'; GCX.font='bold 11px Rajdhani,sans-serif';
      GCX.textAlign='center'; GCX.textBaseline='middle';
      GCX.fillText(lval.toFixed(0),cx+Math.cos(angle)*tr,cy+Math.sin(angle)*tr);
    }
  }
  document.getElementById('gaugeVal').textContent = val.toFixed(gCfg.dec);
  const bf = beaufort(val_ms);
  const badge = document.getElementById('bfBadge');
  badge.textContent=bf.text; badge.style.color=bf.color;
  badge.style.borderColor=bf.color; badge.style.textShadow='0 0 8px '+bf.color+'88';
}

// ===================== CHART HELPERS =====================
function safeMax(arr){
  let m=0; for(let i=0;i<arr.length;i++) if(arr[i]>m) m=arr[i]; return m;
}
function drawTimeLabels(ctx,timestamps,s,e,pad,W,H,dpr){
  if(!timestamps||timestamps.length===0) return;
  const len=e-s+1, cW=W-pad.l-pad.r;
  ctx.fillStyle='#3a5570'; ctx.font=(9*dpr)+'px Share Tech Mono,monospace'; ctx.textAlign='center';
  for(let i=0;i<5;i++){
    const frac=i/4, x=pad.l+frac*cW;
    const idx=Math.min(s+Math.round(frac*(len-1)),timestamps.length-1);
    if(idx>=0&&idx<timestamps.length&&timestamps[idx]){
      const t=timestamps[idx]; ctx.fillText(t.length>=5?t.substring(0,5):t, x, H-4*dpr);
    }
  }
}

// ===================== LIVE CHART (simpel, kein Zoom/Pan) =====================
const lineData=[], lineTimestamps=[];
const LIVE_WINDOW = 60; // immer die letzten 60 Sekunden zeigen
const LC=document.getElementById('lineCanvas'), LX=LC.getContext('2d');

function initLC(){
  const dpr=window.devicePixelRatio||1;
  LC.width=LC.offsetWidth*dpr; LC.height=160*dpr; LC.style.height='160px';
}

function drawLineChart(){
  try {
    const dpr=window.devicePixelRatio||1;
    const W=LC.width, H=LC.height;
    const pad={t:14*dpr, r:8*dpr, b:28*dpr, l:40*dpr};
    const cW=W-pad.l-pad.r, cH=H-pad.t-pad.b;
    LX.clearRect(0,0,W,H);
    if(lineData.length<2) return;

    // Immer die letzten LIVE_WINDOW Punkte zeigen
    const slice = lineData.length <= LIVE_WINDOW
      ? lineData.slice()
      : lineData.slice(lineData.length - LIVE_WINDOW);
    const tsSlice = lineTimestamps.length <= LIVE_WINDOW
      ? lineTimestamps.slice()
      : lineTimestamps.slice(lineTimestamps.length - LIVE_WINDOW);
    if(slice.length < 2) return;

    // Y-Achse
    const rawMax = safeMax(slice);
    const dispMax = toDisplay(Math.max(rawMax, 0.1)) * 1.2;
    for(let i=0; i<=4; i++){
      const y = pad.t + (i/4)*cH;
      LX.beginPath(); LX.moveTo(pad.l,y); LX.lineTo(pad.l+cW,y);
      LX.strokeStyle='rgba(30,45,60,.8)'; LX.lineWidth=1; LX.stroke();
      LX.fillStyle='#2a4050';
      LX.font=(10*dpr)+'px Share Tech Mono,monospace';
      LX.textAlign='right';
      LX.fillText((((4-i)/4)*dispMax).toFixed(gCfg.dec), pad.l-4, y+4*dpr);
    }

    // Punkte berechnen
    const n = slice.length;
    const pts = slice.map((v,i)=>({
      x: pad.l + (i/(n-1))*cW,
      y: pad.t + (1 - toDisplay(v)/dispMax)*cH
    }));

    // Füllfläche
    const grad=LX.createLinearGradient(0,pad.t,0,pad.t+cH);
    grad.addColorStop(0,'rgba(0,212,255,0.25)');
    grad.addColorStop(1,'rgba(0,212,255,0)');
    LX.beginPath();
    pts.forEach((p,i)=>i===0?LX.moveTo(p.x,p.y):LX.lineTo(p.x,p.y));
    LX.lineTo(pts[n-1].x, pad.t+cH);
    LX.lineTo(pts[0].x,   pad.t+cH);
    LX.closePath();
    LX.fillStyle=grad; LX.fill();

    // Linie
    LX.beginPath();
    pts.forEach((p,i)=>i===0?LX.moveTo(p.x,p.y):LX.lineTo(p.x,p.y));
    LX.strokeStyle='#00d4ff'; LX.lineWidth=2*dpr;
    LX.lineJoin='round'; LX.stroke();

    // X-Achse: Anfangs- und Endzeit + Mitte
    LX.fillStyle='#3a5570';
    LX.font=(9*dpr)+'px Share Tech Mono,monospace';
    const yLabel = H - 4*dpr;
    const labels = [
      {x: pad.l,          ts: tsSlice[0]},
      {x: pad.l + cW/2,   ts: tsSlice[Math.floor((n-1)/2)]},
      {x: pad.l + cW,     ts: tsSlice[n-1]},
    ];
    labels.forEach((l,i)=>{
      if(!l.ts) return;
      const t = l.ts.length>=5 ? l.ts.substring(0,5) : l.ts;
      LX.textAlign = i===0?'left': i===2?'right':'center';
      LX.fillText(t, l.x, yLabel);
    });
  } catch(err){ console.error('Chart Fehler:', err); }
}

// ===================== HISTORY CHART =====================
let histData=[],histTimestamps=[],histZoom={start:0,end:1};
let histDrag=false,histDragX=0,histDragZoom=null,histPinch=null;
const HC=document.getElementById('histCanvas'), HX=HC.getContext('2d');
function initHC(){
  const dpr=window.devicePixelRatio||1;
  HC.width=HC.offsetWidth*dpr; HC.height=240*dpr; HC.style.height='240px';
}
function drawHistChart(){
  const dpr=window.devicePixelRatio||1;
  const W=HC.width,H=HC.height,pad={t:14*dpr,r:8*dpr,b:28*dpr,l:40*dpr};
  const cW=W-pad.l-pad.r,cH=H-pad.t-pad.b;
  HX.clearRect(0,0,W,H);
  if(histData.length<2) return;
  const s=Math.floor(histZoom.start*(histData.length-1));
  const e=Math.ceil(histZoom.end*(histData.length-1));
  const slice=histData.slice(s,e+1); if(slice.length<2) return;
  const dispMax=toDisplay(Math.max(safeMax(slice),0.1))*1.15;
  for(let i=0;i<=4;i++){
    const y=pad.t+(i/4)*cH;
    HX.beginPath(); HX.moveTo(pad.l,y); HX.lineTo(pad.l+cW,y);
    HX.strokeStyle='rgba(30,45,60,.8)'; HX.lineWidth=1; HX.stroke();
    HX.fillStyle='#2a4050'; HX.font=(10*dpr)+'px Share Tech Mono,monospace'; HX.textAlign='right';
    HX.fillText((((4-i)/4)*dispMax).toFixed(gCfg.dec),pad.l-4,y+4*dpr);
  }
  const pts=histData.slice(s,e+1).map((v,i)=>({x:pad.l+(i/(slice.length-1))*cW,y:pad.t+(1-toDisplay(v)/dispMax)*cH}));
  const grad=HX.createLinearGradient(0,pad.t,0,pad.t+cH);
  grad.addColorStop(0,'rgba(0,119,170,.35)'); grad.addColorStop(1,'rgba(0,119,170,0)');
  HX.beginPath(); pts.forEach((p,i)=>i===0?HX.moveTo(p.x,p.y):HX.lineTo(p.x,p.y));
  HX.lineTo(pts[pts.length-1].x,pad.t+cH); HX.lineTo(pts[0].x,pad.t+cH);
  HX.closePath(); HX.fillStyle=grad; HX.fill();
  HX.beginPath(); HX.shadowColor='#0099cc'; HX.shadowBlur=6*dpr;
  pts.forEach((p,i)=>i===0?HX.moveTo(p.x,p.y):HX.lineTo(p.x,p.y));
  HX.strokeStyle='#0099cc'; HX.lineWidth=2*dpr; HX.lineJoin='round'; HX.stroke();
  HX.shadowBlur=0;
  drawTimeLabels(HX,histTimestamps,s,Math.min(e,histTimestamps.length-1),pad,W,H,dpr);
}
function zoomHist(f,cf){
  const range=histZoom.end-histZoom.start;
  const nr=Math.min(1,Math.max(0.001,range*f));
  const d=nr-range;
  histZoom.start=Math.max(0,histZoom.start-d*cf);
  histZoom.end=Math.min(1,histZoom.end+d*(1-cf));
  if(histZoom.end>1){histZoom.start=Math.max(0,histZoom.start-(histZoom.end-1));histZoom.end=1;}
  if(histZoom.start<0){histZoom.end=Math.min(1,histZoom.end-histZoom.start);histZoom.start=0;}
  drawHistChart();
}
HC.addEventListener('wheel',e=>{e.preventDefault();const r=HC.getBoundingClientRect();zoomHist(e.deltaY>0?1.2:.83,(e.clientX-r.left)/r.width);},{passive:false});
HC.addEventListener('mousedown',e=>{histDrag=true;histDragX=e.clientX;histDragZoom={...histZoom};});
window.addEventListener('mousemove',e=>{
  if(!histDrag)return;
  const r=HC.getBoundingClientRect(),dx=(e.clientX-histDragX)/r.width;
  let ns=histDragZoom.start-dx,ne=histDragZoom.end-dx;
  if(ns<0){ne-=ns;ns=0;}if(ne>1){ns-=(ne-1);ne=1;}
  histZoom={start:Math.max(0,ns),end:Math.min(1,ne)}; drawHistChart();
});
window.addEventListener('mouseup',()=>histDrag=false);
HC.addEventListener('touchstart',e=>{
  if(e.touches.length===1){histDrag=true;histDragX=e.touches[0].clientX;histDragZoom={...histZoom};}
  if(e.touches.length===2){histPinch=Math.abs(e.touches[0].clientX-e.touches[1].clientX);histDrag=false;}
},{passive:true});
HC.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length===1&&histDrag){
    const r=HC.getBoundingClientRect(),dx=(e.touches[0].clientX-histDragX)/r.width;
    let ns=histDragZoom.start-dx,ne=histDragZoom.end-dx;
    if(ns<0){ne-=ns;ns=0;}if(ne>1){ns-=(ne-1);ne=1;}
    histZoom={start:Math.max(0,ns),end:Math.min(1,ne)}; drawHistChart();
  }
  if(e.touches.length===2&&histPinch!=null){
    const nd=Math.abs(e.touches[0].clientX-e.touches[1].clientX);
    const r=HC.getBoundingClientRect();
    const cx=((e.touches[0].clientX+e.touches[1].clientX)/2-r.left)/r.width;
    zoomHist(histPinch/nd,cx); histPinch=nd;
  }
},{passive:false});
HC.addEventListener('touchend',()=>{histDrag=false;histPinch=null;});

// ===================== RESIZE & INIT =====================
window.addEventListener('resize',()=>{initLC();drawLineChart();initHC();drawHistChart();});

window.addEventListener('load',()=>{
  initLC(); initHC();
  drawGauge(0);
  // Prüfe ob Web Bluetooth verfügbar
  if(!navigator.bluetooth){
    document.getElementById('bleErr').textContent =
      'Web Bluetooth nicht verfuegbar. Bitte Chrome auf Android verwenden.';
  }
});
</script>
</body>
</html>
